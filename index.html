<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title changed to reflect it's live -->
    <title>Sensor Optimization</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 lg:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Sensor Deployment Optimizer</h1>
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- --- LEFT COLUMN: CONTROLS (No changes here) --- -->
            <div class="lg:w-1/3">
                <form id="controls-form" class="space-y-6 bg-white p-6 rounded-lg shadow-md">
                    
                    <!-- 1. Area Parameters -->
                    <h2 class="text-xl font-semibold">1. Area Parameters</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="width" class="block text-sm font-medium text-gray-700">Area Width</label>
                            <input type="number" id="width" value="50" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-700">Area Height</label>
                            <input type="number" id="height" value="50" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                    </div>
                    
                    <!-- 2. Sensor Parameters -->
                    <h2 class="text-xl font-semibold">2. Sensor Parameters</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="maxSensors" class="block text-sm font-medium text-gray-700">Max Sensors</label>
                            <input type="number" id="maxSensors" value="10" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="sensorRange" class="block text-sm font-medium text-gray-700">Sensor Range</label>
                            <input type="number" id="sensorRange" value="7" min="1" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div>
                        <label for="density" class="block text-sm font-medium text-gray-700">Coverage Density (lower=more)</label>
                        <input type="number" id="density" value="2.0" min="0.1" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                    </div>

                    <!-- 3. Priority Areas -->
                    <h2 class="text-xl font-semibold">3. Priority Areas</h2>
                    <div id="priority-areas-list" class="space-y-2">
                        <!-- Areas will be dynamically inserted here by JS -->
                    </div>
                    <div class="grid grid-cols-3 gap-2 p-3 border rounded-md">
                        <label class="col-span-1">
                            <span class="text-sm font-medium text-gray-700">X</span>
                            <input type="number" id="pa_x" value="25" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </label>
                        <label class="col-span-1">
                            <span class="text-sm font-medium text-gray-700">Y</span>
                            <input type="number" id="pa_y" value="25" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </label>
                        <label class="col-span-1">
                            <span class="text-sm font-medium text-gray-700">R</span>
                            <input type="number" id="pa_r" value="5" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </label>
                        <button type="button" id="add-area-btn" class="col-span-3 mt-2 w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 text-sm">
                            Add Priority Area
                        </button>
                    </div>

                    <!-- 4. Submit Button -->
                    <button type="submit" id="submit-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md font-semibold shadow-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <span id="submit-btn-text">Run Optimization</span>
                        <div id="submit-spinner" class="spinner hidden"></div>
                    </button>
                </form>
            </div>

            <!-- --- RIGHT COLUMN: VISUALIZATION (No changes here) --- -->
            <div class="lg:w-2/3">
                <div class="sticky top-8">
                    <h2 class="text-xl font-semibold mb-4">Optimization Results</h2>
                    
                    <!-- Error Message -->
                    <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
                        <!-- Error content here -->
                    </div>
                    
                    <!-- Success Message -->
                    <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-800 px-4 py-3 rounded-lg mb-4">
                        <!-- Success content here -->
                    </div>
                    
                    <!-- Visualization SVG -->
                    <div id="viz-container" class="w-full h-full p-4 bg-white rounded-lg shadow-inner border border-gray-200">
                        <svg id="viz-svg" viewBox="0 0 50 50" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                            <!-- SVG content will be dynamically inserted here by JS -->
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. JavaScript Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- STATE ---
            let priorityAreas = [
                { center: [15, 35], radius: 8 },
                { center: [40, 15], radius: 10 },
            ];
            let isLoading = false;
            
            // --- API URL ---
            // This is the address of your running Flask server
            const API_URL = 'http://127.0.0.1:5000/api/optimize';

            // --- DOM ELEMENTS (No change) ---
            const form = document.getElementById('controls-form');
            const submitBtn = document.getElementById('submit-btn');
            const submitBtnText = document.getElementById('submit-btn-text');
            const submitSpinner = document.getElementById('submit-spinner');
            
            const widthInput = document.getElementById('width');
            const heightInput = document.getElementById('height');
            const maxSensorsInput = document.getElementById('maxSensors');
            const sensorRangeInput = document.getElementById('sensorRange');
            const densityInput = document.getElementById('density');
            
            const priorityAreasList = document.getElementById('priority-areas-list');
            const addAreaBtn = document.getElementById('add-area-btn');
            const paXInput = document.getElementById('pa_x');
            const paYInput = document.getElementById('pa_y');
            const paRInput = document.getElementById('pa_r');
            
            const vizContainer = document.getElementById('viz-container');
            const vizSvg = document.getElementById('viz-svg');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');

            // --- MOCK DATA (REMOVED) ---
            // const mockResults = { ... }; // This is no longer needed!

            // --- FUNCTIONS ---
            
            /**
             * Renders the list of priority areas based on the state
             * (No change in this function)
             */
            function renderPriorityAreas() {
                priorityAreasList.innerHTML = ''; // Clear list
                if (priorityAreas.length === 0) {
                    priorityAreasList.innerHTML = '<p class="text-sm text-gray-500 text-center">No priority areas added.</p>';
                }
                
                priorityAreas.forEach((area, idx) => {
                    const areaEl = document.createElement('div');
                    areaEl.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                    areaEl.innerHTML = `
                        <span class="text-sm">
                            Area #${idx + 1}: (x: ${area.center[0]}, y: ${area.center[1]}, r: ${area.radius})
                        </span>
                        <button type="button" data-index="${idx}" class="remove-area-btn text-red-500 hover:text-red-700 text-sm font-medium">Remove</button>
                    `;
                    priorityAreasList.appendChild(areaEl);
                });
                
                // Redraw the base visualization (without results)
                renderVisualization(); 
            }

            /**
             * Adds a new priority area from the input fields
             * (No change in this function)
             */
            function handleAddArea() {
                const x = parseFloat(paXInput.value);
                const y = parseFloat(paYInput.value);
                const r = parseFloat(paRInput.value);

                if (isNaN(x) || isNaN(y) || isNaN(r) || r <= 0) {
                    showError("Please enter valid X, Y, and a positive Radius.");
                    return;
                }
                
                priorityAreas.push({ center: [x, y], radius: r });
                renderPriorityAreas();
                
                // Reset inputs for convenience
                paXInput.value = Math.floor(Math.random() * 50);
                paYInput.value = Math.floor(Math.random() * 50);
                paRInput.value = 5;
            }

            /**
             * Removes a priority area when its "Remove" button is clicked
             * (No change in this function)
             */
            function handleRemoveArea(e) {
                if (e.target.classList.contains('remove-area-btn')) {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    priorityAreas = priorityAreas.filter((_, idx) => idx !== indexToRemove);
                    renderPriorityAreas();
                }
            }
            
            /**
             * Main function to run the optimization
             * --- THIS IS THE UPDATED FUNCTION ---
             */
            async function handleSubmit(e) {
                e.preventDefault();
                if (isLoading) return;

                setLoading(true);
                
                // 1. Collect all parameters into a payload
                const payload = {
                    width: parseFloat(widthInput.value),
                    height: parseFloat(heightInput.value),
                    max_sensors: parseInt(maxSensorsInput.value, 10),
                    sensor_range: parseFloat(sensorRangeInput.value),
                    density: parseFloat(densityInput.value),
                    priority_areas: priorityAreas
                };

                try {
                    // 2. Call the Flask API
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    // 3. Get the JSON response
                    const results = await response.json();

                    // 4. Check for errors from the server
                    if (!response.ok) {
                        // `results.error` comes from `jsonify({"error": ...})` in Flask
                        throw new Error(results.error || "An unknown server error occurred.");
                    }

                    // 5. Success! Show the results.
                    showSuccess(results.status, results.summary);
                    renderVisualization(results);

                } catch (err) {
                    // 6. Handle network errors or server errors
                    console.error("Optimization Error:", err);
                    showError(err.message);
                    renderVisualization(); // Clear any old results
                } finally {
                    // 7. Always re-enable the button
                    setLoading(false);
                }
            }
            
            /**
             * Renders the SVG visualization
             * (No change in this function)
             */
            function renderVisualization(results = null) {
                const width = parseFloat(widthInput.value) || 50;
                const height = parseFloat(heightInput.value) || 50;
                const sensorRange = parseFloat(sensorRangeInput.value) || 7;
                
                // SVG Y-coordinate flip
                const yFlip = (y) => height - y;
                
                // Update SVG viewport
                vizSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                vizContainer.style.aspectRatio = `${width} / ${height}`;

                let svgContent = '';

                // 1. Background Grid
                const gridStep = width / 10;
                svgContent += `
                    <defs>
                        <pattern id="grid" width="${gridStep}" height="${gridStep}" patternUnits="userSpaceOnUse">
                            <path d="M ${gridStep} 0 L 0 0 0 ${gridStep}" fill="none" stroke="#e5e7eb" stroke-width="0.3"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" opacity="0.7" />
                    <rect width="100%" height="100%" fill="none" stroke="#9ca3af" stroke-width="0.5" />
                `;

                // 2. Plot Priority Areas
                priorityAreas.forEach((area) => {
                    svgContent += `
                        <circle
                            cx="${area.center[0]}"
                            cy="${yFlip(area.center[1])}"
                            r="${area.radius}"
                            fill="rgba(255, 0, 0, 0.1)"
                            stroke="red"
                            stroke-width="0.5"
                            stroke-dasharray="2 2"
                        />`;
                });

                // 3. Plot Results (if they exist)
                if (results) {
                    // a) Uncovered Sub-Targets
                    results.uncoveredSubTargets.forEach(([x, y]) => {
                        svgContent += `<circle cx="${x}" cy="${yFlip(y)}" r="0.5" fill="#ff9999" />`;
                    });
                    
                    // b) Covered Sub-Targets
                    results.coveredSubTargets.forEach(([x, y]) => {
                        svgContent += `<circle cx="${x}" cy="${yFlip(y)}" r="0.5" fill="green" />`;
                    });
                    
                    // c) Placed Sensors & their range
                    results.placedSensors.forEach(([x, y]) => {
                        svgContent += `
                            <g>
                                <circle
                                    cx="${x}"
                                    cy="${yFlip(y)}"
                                    r="${sensorRange}"
                                    fill="rgba(0, 0, 255, 0.1)"
                                    stroke="blue"
                                    stroke-width="0.5"
                                    stroke-dasharray="2 2"
                                />
                                <path
                                    d="M ${x} ${yFlip(y)} l -1.5 2 l 3 0 z"
                                    fill="blue"
                                    stroke="black"
                                    stroke-width="0.2"
                                />
                            </g>`;
                    });
                }
                
                vizSvg.innerHTML = svgContent;
            }

            // --- UI HELPER FUNCTIONS ---
            // (No change in these functions)
            
            function setLoading(loading) {
                isLoading = loading;
                submitBtn.disabled = loading;
                if (loading) {
                    submitBtnText.textContent = "Optimizing...";
                    submitSpinner.classList.remove('hidden');
                    errorMessage.classList.add('hidden');
                    successMessage.classList.add('hidden');
                } else {
                    submitBtnText.textContent = "Run Optimization";
                    submitSpinner.classList.add('hidden');
                }
            }
            
            function showError(message) {
                errorMessage.innerHTML = `<strong>Error:</strong> ${message}`;
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
            }
            
            function showSuccess(status, summary) {
                successMessage.innerHTML = `<strong>${status}:</strong> ${summary}`;
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            }

            // --- INITIALIZATION ---
            renderPriorityAreas(); // Draw default areas and wire up visualization on load
            
            // --- EVENT LISTENERS ---
            // (No change in these)
            form.addEventListener('submit', handleSubmit);
            addAreaBtn.addEventListener('click', handleAddArea);
            priorityAreasList.addEventListener('click', handleRemoveArea);
            
            // Re-draw base visualization if parameters change
            widthInput.addEventListener('change', () => renderVisualization());
            heightInput.addEventListener('change', () => renderVisualization());

        });
    </script>
</body>
</html>